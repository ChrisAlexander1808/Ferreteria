<div class="d-flex flex-column flex-root">
  <div class="d-flex flex-row flex-column-fluid page">
    <app-sidebar></app-sidebar>

    <div class="d-flex flex-column flex-row-fluid wrapper" id="kt_wrapper">
      <app-top></app-top>

      <div class="content d-flex flex-column flex-column-fluid" id="kt_content">

        <div class="subheader py-2 py-lg-4 subheader-solid" id="kt_subheader">
          <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
            <div class="d-flex align-items-center flex-wrap mr-2">
              <h5 class="text-dark font-weight-bold mt-2 mb-2 mr-5">ERP Ferronix</h5>
              <div class="subheader-separator subheader-separator-ver mt-2 mb-2 mr-4 bg-gray-200"></div>
              <span class="text-muted font-weight-bold mr-4">Kardex de Producto</span>
            </div>

            <div class="d-flex align-items-center">
              <button type="button" class="btn btn-light" (click)="volver()">
                <i class="flaticon2-left-arrow-1"></i> Volver
              </button>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column-fluid">
          <div class="container">

            <div class="card card-custom gutter-b">
              <div class="card-header">
                <div class="card-title">
                  <h3 class="card-label">
                    Kardex
                    <span class="text-muted pt-2 font-size-sm d-block">
                      Movimientos de inventario del producto seleccionado
                    </span>
                  </h3>
                </div>
              </div>

              <div class="card-body">

                <!-- Loader -->
                <div *ngIf="loading" class="text-center my-10">
                  <div class="spinner-border" style="width: 3rem; height: 3rem" role="status">
                    <span class="sr-only">Cargando...</span>
                  </div>
                </div>

                <div *ngIf="!loading">

                  <!-- Info producto -->
                  <div class="alert alert-custom alert-light-primary" role="alert" *ngIf="producto">
                    <div class="alert-icon"><i class="flaticon2-information"></i></div>
                    <div class="alert-text">
                      <div class="d-flex flex-wrap">
                        <div class="mr-8">
                          <strong>Producto:</strong> {{ producto.nombre }} <span class="text-muted">({{ producto.codigo }})</span>
                        </div>
                        <div class="mr-8">
                          <strong>Unidad:</strong> {{ producto.unidad_medida }}
                        </div>
                        <div class="mr-8">
                          <strong>Stock actual:</strong> {{ producto.stock_actual }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Filtros -->
                  <div class="row align-items-end mb-6">
                    <div class="col-lg-3">
                      <label class="font-weight-bold">Desde</label>
                      <input type="date" class="form-control" [(ngModel)]="desde" />
                    </div>

                    <div class="col-lg-3">
                      <label class="font-weight-bold">Hasta</label>
                      <input type="date" class="form-control" [(ngModel)]="hasta" />
                    </div>

                    <div class="col-lg-6 d-flex">
                      <button type="button" class="btn btn-primary mr-2" (click)="cargarKardex()">
                        <i class="flaticon2-search"></i> Buscar
                      </button>

                      <button type="button" class="btn btn-light" (click)="limpiarFiltros()">
                        <i class="flaticon2-refresh"></i> Limpiar
                      </button>
                    </div>
                  </div>

                  <!-- Resumen -->
                  <div class="row mb-6">
                    <div class="col-lg-4">
                      <div class="card card-custom bg-light-success">
                        <div class="card-body py-4">
                          <div class="font-weight-bold">Entradas</div>
                          <div class="font-size-h4">{{ totalEntradas }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <div class="card card-custom bg-light-danger">
                        <div class="card-body py-4">
                          <div class="font-weight-bold">Salidas</div>
                          <div class="font-size-h4">{{ totalSalidas }}</div>
                        </div>
                      </div>
                    </div>
                    <div class="col-lg-4">
                      <div class="card card-custom bg-light-primary">
                        <div class="card-body py-4">
                          <div class="font-weight-bold">Saldo final</div>
                          <div class="font-size-h4">{{ saldoFinal }}</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Tabla Kardex -->
                  <div class="table-responsive">
                    <table class="table table-head-custom table-vertical-center">
                      <thead>
                        <tr class="text-left">
                          <th style="min-width: 160px">Fecha</th>
                          <th style="min-width: 160px">Hora</th>
                          <th style="min-width: 110px">Tipo</th>
                          <th style="min-width: 220px">Motivo</th>
                          <th style="min-width: 160px">Referencia</th>
                          <th class="text-right" style="min-width: 110px">Entrada</th>
                          <th class="text-right" style="min-width: 110px">Salida</th>
                          <th class="text-right" style="min-width: 110px">Saldo</th>
                        </tr>
                      </thead>

                      <tbody *ngIf="kardex && kardex.length > 0; else sinDatos">
                        <tr *ngFor="let k of kardex">
                          <td>
                            {{ k.fecha | date: 'dd/MM/yyyy' }}
                          </td>
                           <td>
                            {{ k.fecha | date: 'HH:mm' }}
                          </td>

                          <td>
                            <span
                            class="label label-inline"
                            [ngClass]="{
                                'label-success': k.tipo === 'ENTRADA',
                                'label-danger': k.tipo === 'SALIDA',
                                'label-warning': k.tipo === 'AJUSTE'
                            }"
                            >
                            {{ k.tipo }}
                            </span>
                          </td>

                          <td>{{ k.motivo || '—' }}</td>
                          <td>{{ k.referencia || '—' }}</td>

                          <td class="text-right">
                            <span class="text-success font-weight-bold">
                              {{ k.entrada || 0 }}
                            </span>
                          </td>

                          <td class="text-right">
                            <span class="text-danger font-weight-bold">
                              {{ k.salida || 0 }}
                            </span>
                          </td>

                          <td class="text-right">
                            <strong>{{ k.saldo }}</strong>
                          </td>
                        </tr>
                      </tbody>
                    </table>

                    <ng-template #sinDatos>
                      <div class="text-muted text-center my-8">
                        No hay movimientos para el rango seleccionado.
                      </div>
                    </ng-template>
                  </div>

                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</div>
