<div class="d-flex flex-column flex-root">
  <div class="d-flex flex-row flex-column-fluid page">
    <app-sidebar></app-sidebar>

    <div class="d-flex flex-column flex-row-fluid wrapper" id="kt_wrapper">
      <app-top></app-top>

      <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
        <!--begin::Subheader-->
        <div class="subheader py-2 py-lg-4 subheader-solid" id="kt_subheader">
          <div
            class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap"
          >
            <div class="d-flex align-items-center flex-wrap mr-2">
              <h5 class="text-dark font-weight-bold mt-2 mb-2 mr-5">
                ERP Ferronix
              </h5>
              <div
                class="subheader-separator subheader-separator-ver mt-2 mb-2 mr-4 bg-gray-200"
              ></div>
              <span class="text-muted font-weight-bold mr-4"
                >Nueva Venta</span
              >
            </div>
          </div>
        </div>
        <!--end::Subheader-->

        <!--begin::Entry-->
        <div class="d-flex flex-column-fluid">
          <div class="container">
            <div class="card card-custom">
              <div class="card-header">
                <div class="card-title">
                  <h3 class="card-label">
                    Nueva Venta
                    <span class="text-muted pt-2 font-size-sm d-block"
                      >Registro de venta con detalle de productos y
                      servicios</span
                    >
                  </h3>
                </div>
              </div>

              <div class="card-body">
                <!-- Loader inicial -->
                <div *ngIf="loadingData" class="text-center my-10">
                  <div
                    class="spinner-border"
                    style="width: 3rem; height: 3rem"
                    role="status"
                  >
                    <span class="sr-only">Cargando...</span>
                  </div>
                </div>

                <div *ngIf="!loadingData">
                  <!-- CABECERA -->
                <div class="form-group row">
                <label class="col-lg-2 col-form-label text-left">Cliente</label>
                <div class="col-lg-4">
                    <ng-select
                    [items]="clientes"
                    bindLabel="nombre"
                    bindValue="id"
                    placeholder="Seleccionar cliente"
                    [(ngModel)]="selectedClienteId"
                    [searchable]="true"
                    [clearable]="true"
                    [searchFn]="clienteSearchFn"
                    name="cliente_id"
                    class="w-100"
                    >
                    <ng-template ng-option-tmp let-item="item">
                        {{ item.nombre }}
                        <span *ngIf="item.nit"> - NIT: {{ item.nit }}</span>
                    </ng-template>
                    </ng-select>
                </div>

                <label class="col-lg-2 col-form-label text-left"
                    >Fecha <span style="color: red">*</span></label
                >
                <div class="col-lg-4">
                    <input
                    type="date"
                    class="form-control"
                    name="fecha"
                    [(ngModel)]="fecha"
                    />
                </div>
                </div>

                <div class="form-group row">
                    <label class="col-lg-2 col-form-label text-left">
                        Tipo de venta <span style="color: red">*</span>
                    </label>

                    <div class="col-lg-4">
                        <div class="btn-group">
                        <button
                            type="button"
                            class="btn btn-sm"
                            [ngClass]="{
                            'btn-primary': selectedTipoVenta === 'CONTADO',
                            'btn-outline-primary': selectedTipoVenta !== 'CONTADO'
                            }"
                            (click)="setTipoVenta('CONTADO')"
                        >
                            Contado
                        </button>

                        <button
                            type="button"
                            class="btn btn-sm ml-2"
                            [ngClass]="{
                            'btn-info': selectedTipoVenta === 'CREDITO',
                            'btn-outline-info': selectedTipoVenta !== 'CREDITO'
                            }"
                            (click)="setTipoVenta('CREDITO')"
                        >
                            Crédito
                        </button>
                        </div>
                    </div>

                    <label class="col-lg-2 col-form-label text-left">
                        No. Factura
                    </label>
                    <div class="col-lg-4">
                        <input
                        type="text"
                        class="form-control"
                        name="num_factura"
                        [(ngModel)]="num_factura"
                        placeholder="Número de factura (opcional)"
                        />
                    </div>
                    </div>


                <div class="form-group row" *ngIf="selectedTipoVenta === 'CONTADO'">
                <label class="col-lg-2 col-form-label text-left">
                    Método de pago <span style="color: red">*</span>
                </label>
                <div class="col-lg-4">
                    <ng-select
                    [items]="metodosPago"
                    bindLabel="nombre"
                    bindValue="id"
                    placeholder="Seleccione método de pago"
                    [(ngModel)]="selectedMetodoPagoId"
                    name="metodo_pago_id"
                    class="w-100"
                    [clearable]="true"
                    >
                    <ng-template ng-option-tmp let-item="item">
                        {{ item.nombre }}
                        <span *ngIf="item.descripcion"> - {{ item.descripcion }}</span>
                    </ng-template>
                    </ng-select>
                </div>
                </div>

                <div class="form-group row">
                <label class="col-lg-2 col-form-label text-left">Observación</label>
                <div class="col-lg-10">
                    <textarea
                    class="form-control"
                    rows="2"
                    name="observacion"
                    [(ngModel)]="observacion"
                    placeholder="Comentarios adicionales de la venta"
                    ></textarea>
                </div>
                </div>

                <hr />


                  <!-- DETALLE -->
                  <h4 class="mb-4">Detalle de la Venta</h4>

                  <div class="table-responsive">
                    <table
                      class="table table-head-custom table-vertical-center"
                    >
                      <thead>
                        <tr class="text-left">
                          <th style="min-width: 80px">#</th>
                          <th style="min-width: 120px">Tipo</th>
                          <th style="min-width: 220px">Producto / Servicio</th>
                          <th style="min-width: 100px">Stock</th>
                          <th style="min-width: 100px">Cantidad</th>
                          <th style="min-width: 120px">Precio</th>
                          <th style="min-width: 120px">Subtotal</th>
                          <th style="min-width: 60px"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr
                          *ngFor="let d of detalles; let i = index"
                        >
                          <td>{{ i + 1 }}</td>

                          <!-- Tipo -->
                          <td>
                            <select
                              class="form-control"
                              name="tipo_item_{{ i }}"
                              [(ngModel)]="d.tipo_item"
                              (change)="onTipoChange(d)"
                            >
                              <option value="">Seleccione</option>
                              <option value="BIEN">BIEN</option>
                              <option value="SERVICIO">SERVICIO</option>
                            </select>
                          </td>

                          <!-- Producto / Servicio -->
                          <td>
                            <!-- BIEN -->
                            <ng-container *ngIf="d.tipo_item === 'BIEN'; else esServicio">
                                <ng-select
                                    [items]="productos"
                                    bindLabel="nombre"
                                    bindValue="id"
                                    placeholder="Seleccione producto"
                                    [(ngModel)]="d.producto_id"
                                    (change)="onProductoChange(d)"
                                    [searchable]="true"
                                    [clearable]="false"
                                    name="producto_id_{{ i }}"
                                    class="w-100 ng-select-bootstrap"
                                >
                                    <!-- Etiqueta seleccionada -->
                                    <ng-template ng-label-tmp let-item="item">
                                    {{ item.nombre }} ({{ item.codigo }})
                                    </ng-template>

                                    <!-- Opciones del dropdown -->
                                    <ng-template ng-option-tmp let-item="item">
                                    <div class="d-flex flex-column">
                                        <span class="font-weight-bold">
                                        {{ item.nombre }} ({{ item.codigo }})
                                        </span>
                                    </div>
                                    </ng-template>
                                </ng-select>
                            </ng-container>

                                <ng-template #esServicio>
                                <input
                                    type="text"
                                    class="form-control"
                                    placeholder="Descripción del servicio"
                                    name="descripcion_{{ i }}"
                                    [(ngModel)]="d.descripcion"
                                />
                                </ng-template>
                          </td>

                          <!-- Stock -->
                          <td>
                            <span
                              *ngIf="d.tipo_item === 'BIEN'"
                              class="text-dark-75"
                            >
                              {{ d.producto_stock || 0 }}
                            </span>
                            <span
                              *ngIf="d.tipo_item === 'SERVICIO'"
                              class="text-muted"
                              >N/A</span
                            >
                          </td>

                          <!-- Cantidad -->
                          <td>
                            <input
                            type="number"
                            min="1"
                            class="form-control"
                            name="cantidad_{{ i }}"
                            [(ngModel)]="d.cantidad"
                            (change)="onCantidadOrPrecioChange(d)"
                            [ngClass]="{ 'is-invalid': d.errorStock }"
                            />

                            <div *ngIf="d.errorStock" class="invalid-feedback d-block">
                            {{ d.errorStockMsg }}
                            </div>

                          </td>

                          <!-- Precio -->
                          <td>
                            <input
                              type="number"
                              min="0"
                              step="0.01"
                              class="form-control"
                              name="precio_{{ i }}"
                              [(ngModel)]="d.precio_unitario"
                              (change)="onCantidadOrPrecioChange(d)"
                            />
                          </td>

                          <!-- Subtotal -->
                          <td>
                            <span class="text-dark-75 font-size-lg">
                              {{ d.subtotal | currency: 'Q' }}
                            </span>
                          </td>

                          <!-- Quitar línea -->
                          <td class="text-center">
                            <a
                              style="cursor: pointer"
                              (click)="removeLinea(i)"
                              *ngIf="detalles.length > 1"
                            >
                              <i class="fas fa-trash-alt text-danger"></i>
                            </a>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <div class="mt-3">
                    <button
                      type="button"
                      class="btn btn-light-primary btn-sm font-weight-bold"
                      (click)="addLinea()"
                    >
                      <i class="flaticon-add-circular-button"></i>
                      Agregar línea
                    </button>
                  </div>

                  <hr />

                  <!-- TOTAL -->
                  <div class="row">
                    <div class="col-lg-8"></div>
                    <div class="col-lg-4 text-right">
                      <h4>
                        Total:
                        <strong>{{ total | currency: 'Q' }}</strong>
                      </h4>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card-footer">
                <div class="text-right">
                  <button
                    type="button"
                    class="btn btn-secondary font-weight-bold mr-2"
                    (click)="cancelar()"
                  >
                    Cancelar
                  </button>

                  <button
                    *ngIf="!saving"
                    type="button"
                    class="btn btn-primary font-weight-bold"
                    (click)="guardarVenta()"
                  >
                    Guardar Venta
                  </button>

                  <button
                    *ngIf="saving"
                    class="btn btn-primary font-weight-bold"
                    type="button"
                    disabled
                  >
                    <span
                      class="spinner-border spinner-border-sm"
                      role="status"
                      aria-hidden="true"
                    ></span>
                    Guardando...
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!--end::Container-->
        </div>
        <!--end::Entry-->
      </div>
    </div>
  </div>
</div>
